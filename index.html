<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GHLK Health Care System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="">
  <style>
    /* Modern color scheme */
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
    }

    /* Improved layout and spacing */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }

    .ghlk-navbar {
      background-color: var(--primary-color);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .ghlk-navbar .navbar-brand img {
      height: 40px;
    }

    .ghlk-navbar .nav-link {
      color: white !important;
      margin: 0 10px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .ghlk-navbar .nav-link:hover {
      color: var(--light-color) !important;
      transform: translateY(-2px);
    }

    .login-btn {
      background-color: var(--secondary-color);
      border-radius: 20px;
      padding: 5px 15px;
      transition: all 0.3s;
    }

    .login-btn:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    /* Hero section improvements */
    .hero-section {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 80px 0;
      text-align: center;
    }

    .ghlk-logo-large {
      height: 120px;
      margin-bottom: 20px;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
    }

    /* Form container styling */
    .form-container {
      max-width: 800px;
      margin: 30px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    /* ID card styling */
    #idCard {
      width: 85mm;
      border: 2px solid var(--primary-color);
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      margin: 0 auto;
    }

    /* Photo preview styling */
    #photoPreview,
    #idCardPhoto,
    #visitorPhoto {
      width: 35mm;
      height: 45mm;
      margin-top: 10px;
      display: none;
      border-radius: 5px;
      border: 1px solid #ddd;
      object-fit: cover;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Calendar styling */
    .attendance-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 15px;
    }

    .calendar-day {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
    }

    .present {
      background-color: #2ecc71;
      color: white;
    }

    .absent {
      background-color: #e74c3c;
      color: white;
    }

    /* Button styling */
    .btn-primary {
      background-color: var(--secondary-color);
      border: none;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      min-width: 250px;
      z-index: 1100;
    }

    /* QR Scanner Styles */
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 40%;
      border: 3px solid #3498db;
      box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }

    #qrScanner video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .form-container {
        padding: 20px;
        margin: 15px;
      }

      #idCard {
        width: 100%;
      }

      .hero-section {
        padding: 50px 0;
      }
    }
  </style>
</head>

<body>
  <!-- Home Page -->
  <div id="homePage">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark ghlk-navbar">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img src="" alt="GHLK Logo">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#home">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#about">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#contact">Contact</a>
            </li>
            <li class="nav-item">
              <a class="nav-link login-btn" href="#" id="homeLoginBtn">
                <i class="fas fa-sign-in-alt"></i> Staff Login
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section" id="home">
      <div class="container">
        <img src="" alt="GHLK Logo" class="ghlk-logo-large">
        <h1 class="display-4">GHLK Health Care Center</h1>
        <p class="lead">Rampur-5, Palpa - Providing Quality Healthcare Since 2005</p>

        <div class="d-flex justify-content-center mt-4">
          <button class="btn btn-light btn-lg mx-2" id="homeScanBtn">
            <i class="fas fa-qrcode"></i> Scan Patient ID
          </button>
          <button class="btn btn-outline-light btn-lg mx-2" id="learnMoreBtn">
            <i class="fas fa-info-circle"></i> Learn More
          </button>
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section class="py-5" id="about">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <h2 class="display-5 mb-4">About Our Facility</h2>
            <p class="lead">GHLK Health Care Center is committed to providing exceptional healthcare services to our
              community.</p>
            <p>Founded in 2005, we have grown to become a trusted healthcare provider in the Palpa region, offering a
              wide range of medical services with state-of-the-art facilities and a team of experienced professionals.
            </p>
            <ul class="list-unstyled">
              <li><i class="fas fa-check text-success me-2"></i> 24/7 Emergency Services</li>
              <li><i class="fas fa-check text-success me-2"></i> Experienced Medical Staff</li>
              <li><i class="fas fa-check text-success me-2"></i> Modern Diagnostic Equipment</li>
              <li><i class="fas fa-check text-success me-2"></i> Patient-Centered Care</li>
            </ul>
          </div>
          <div class="col-lg-6">
            <img src="" alt="Our Facility"
              class="img-fluid rounded shadow">
          </div>
        </div>
      </div>
    </section>

    <!-- Services Section -->
    <section class="py-5 bg-light">
      <div class="container">
        <h2 class="text-center mb-5">Our Services</h2>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm text-center">
              <div class="card-body">
                <i class="fas fa-heartbeat fa-3x text-danger mb-3"></i>
                <h5>Cardiology</h5>
                <p class="text-muted">Comprehensive heart care with advanced diagnostic tools and treatment options.</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm text-center">
              <div class="card-body">
                <i class="fas fa-bone fa-3x text-primary mb-3"></i>
                <h5>Orthopedics</h5>
                <p class="text-muted">Specialized care for bones, joints, and musculoskeletal conditions.</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm text-center">
              <div class="card-body">
                <i class="fas fa-brain fa-3x text-info mb-3"></i>
                <h5>Neurology</h5>
                <p class="text-muted">Expert diagnosis and treatment for neurological disorders.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Contact Section -->
    <section class="py-5" id="contact">
      <div class="container">
        <h2 class="text-center mb-5">Contact Us</h2>
        <div class="row">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h5><i class="fas fa-map-marker-alt text-primary me-2"></i> Address</h5>
                <p>Rampur-5, Palpa, Nepal</p>

                <h5 class="mt-4"><i class="fas fa-phone text-primary me-2"></i> Phone</h5>
                <p>+977 1234567890</p>

                <h5 class="mt-4"><i class="fas fa-envelope text-primary me-2"></i> Email</h5>
                <p>info@ghlk.com</p>

                <h5 class="mt-4"><i class="fas fa-clock text-primary me-2"></i> Hours</h5>
                <p>24/7 Emergency Services<br>
                  OPD: 8AM - 6PM Daily</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h5>Send Us a Message</h5>
                <form id="contactForm">
                  <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Your Name" required>
                  </div>
                  <div class="mb-3">
                    <input type="email" class="form-control" placeholder="Your Email" required>
                  </div>
                  <div class="mb-3">
                    <input type="tel" class="form-control" placeholder="Phone Number">
                  </div>
                  <div class="mb-3">
                    <textarea class="form-control" rows="4" placeholder="Your Message" required></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Send Message</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>GHLK Health Care Center</h5>
            <p>Committed to providing quality healthcare services to our community.</p>
          </div>
          <div class="col-md-3">
            <h5>Quick Links</h5>
            <ul class="list-unstyled">
              <li><a href="#home" class="text-white">Home</a></li>
              <li><a href="#about" class="text-white">About</a></li>
              <li><a href="#contact" class="text-white">Contact</a></li>
            </ul>
          </div>
          <div class="col-md-3">
            <h5>Connect With Us</h5>
            <div class="social-links">
              <a href="#" class="text-white me-2"><i class="fab fa-facebook-f"></i></a>
              <a href="#" class="text-white me-2"><i class="fab fa-twitter"></i></a>
              <a href="#" class="text-white me-2"><i class="fab fa-instagram"></i></a>
              <a href="#" class="text-white"><i class="fab fa-linkedin-in"></i></a>
            </div>
          </div>
        </div>
        <hr>
        <div class="text-center">
          <p class="mb-0">&copy; 2023 GHLK Health Care Center. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Staff Login</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="staffLoginForm">
              <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">Login</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Visitor Scanner Modal -->
    <div class="modal fade" id="visitorScannerModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Patient Identification</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="input-group mb-3">
              <input type="text" id="visitorManualId" class="form-control" placeholder="Enter Patient ID">
              <button id="visitorSearchBtn" class="btn btn-primary">Search</button>
            </div>

            <div class="d-flex align-items-center my-3">
              <hr class="flex-grow-1">
              <span class="mx-2">OR</span>
              <hr class="flex-grow-1">
            </div>

            <div id="visitorQrScanner" style="width:100%;height:300px;border:2px dashed #ccc;"></div>
            <div id="visitorScanResult" class="mt-3 text-center fw-bold"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main System (hidden by default) -->
  <div id="mainSystem" class="container py-4" style="display: none;">
    <!-- System Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-0">
          <i class="fas fa-hospital me-2"></i> GHLK Patient Management System
        </h2>
        <small class="text-muted">Logged in as: <span id="loggedInUser">Admin</span></small>
      </div>
      <button id="logoutBtn" class="btn btn-danger">
        <i class="fas fa-sign-out-alt me-1"></i> Logout
      </button>
    </div>

    <!-- Navigation Cards -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm text-center hover-effect" id="showRegistrationBtn">
          <div class="card-body">
            <i class="fas fa-user-plus fa-3x text-primary mb-3"></i>
            <h5>Register Patient</h5>
            <p class="text-muted">Add new patient to the system</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm text-center hover-effect" id="showPatientsBtn">
          <div class="card-body">
            <i class="fas fa-users fa-3x text-info mb-3"></i>
            <h5>Patient Records</h5>
            <p class="text-muted">View all registered patients</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm text-center hover-effect" id="showAttendanceBtn">
          <div class="card-body">
            <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
            <h5>Attendance</h5>
            <p class="text-muted">View patient attendance</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm text-center hover-effect" id="scanQrBtn">
          <div class="card-body">
            <i class="fas fa-qrcode fa-3x text-warning mb-3"></i>
            <h5>Patient Lookup</h5>
            <p class="text-muted">Scan or search for patient</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Registration Form -->
    <div id="registrationForm" class="form-container" style="display: none;">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
        onclick="hideForm('registrationForm')"></button>
      <h3 class="text-center mb-4">
        <i class="fas fa-user-plus me-2"></i> Patient Registration
      </h3>
      <form id="health-form">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="name" name="name" required>
            </div>

            <div class="mb-3">
              <label for="age" class="form-label">Age <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="age" name="age" min="1" max="120" required>
            </div>

            <div class="mb-3">
              <label for="address" class="form-label">Address</label>
              <textarea class="form-control" id="address" name="address" rows="2"></textarea>
            </div>

            <div class="mb-3">
              <label for="contact_number" class="form-label">Contact Number <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="contact_number" name="contact_number" pattern="[0-9]{10,15}"
                title="10-15 digit phone number" required>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
              <select class="form-select" id="gender" name="gender" required>
                <option value="" selected disabled>Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Passport Photo (35mm x 45mm)</label>
              <div class="d-flex gap-2 mb-2">
                <button type="button" class="btn btn-outline-secondary" id="takePhotoBtn">
                  <i class="fas fa-camera me-1"></i> Take Photo
                </button>
                <button type="button" class="btn btn-outline-secondary" id="uploadPhoto">
                  <i class="fas fa-upload me-1"></i> Upload
                </button>
                <input type="file" id="photoInput" accept="image/*" style="display: none;">
              </div>
              <video id="video" playsinline style="display: none; width: 100%;"></video>
              <img id="photoPreview" alt="Photo preview" class="d-block mx-auto">
              <button type="button" class="btn btn-outline-danger mt-2 mx-auto d-block" id="retakePhoto"
                style="display: none;">
                <i class="fas fa-redo me-1"></i> Retake
              </button>
            </div>

            <div class="mb-3">
              <label for="health_issues" class="form-label">Health Issues</label>
              <input type="text" class="form-control" id="health_issues" name="health_issues">
            </div>

            <div class="mb-3">
              <label for="joining_date" class="form-label">Joining Date</label>
              <input type="date" class="form-control" id="joining_date" name="joining_date">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="surgery" class="form-label">Surgery History</label>
              <input type="text" class="form-control" id="surgery" name="surgery">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="paralysis_status" class="form-label">Paralysis Status</label>
              <select class="form-select" id="paralysis_status" name="paralysis_status">
                <option value="" selected>Select Status</option>
                <option value="None">None</option>
                <option value="Partial">Partial</option>
                <option value="Full">Full</option>
              </select>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="other_details" class="form-label">Other Details</label>
          <textarea class="form-control" id="other_details" name="other_details" rows="2"></textarea>
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-save me-1"></i> Register Patient
          </button>
        </div>
      </form>
    </div>

    <!-- ID Card Section -->
    <div id="idCardContainer" class="form-container" style="display: none;">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
        onclick="hideForm('idCardContainer')"></button>
      <div id="idCard">
        <div class="company-header text-center mb-3">
          <h2 class="mb-1">GHLK Health Care Center</h2>
          <p class="mb-0">Rampur-5, Palpa, Nepal</p>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <img id="idCardPhoto" alt="Patient Photo" class="photo border">
          </div>
          <div class="qr">
            <img id="qrCode" src="" alt="QR Code">
          </div>
        </div>

        <div class="details">
          <b>Patient ID:</b> <span id="idCardPatientId">GHLK00001</span>
          <b>Name:</b> <span id="idCardName">John Doe</span>
          <b>Age:</b> <span id="idCardAge">30</span>
          <b>Address:</b> <span id="idCardAddress">123 Main St, Palpa</span>
          <b>Mobile:</b> <span id="idCardMobile">+977 9876543210</span>
          <b>Join Date:</b> <span id="idCardJoiningDate">2023-06-15</span>
        </div>

        <div class="signature-space mt-3">
          <p class="mb-0">Authorized Signatory with Stamp</p>
        </div>

        <div class="id-card-footer text-center mt-3">
          <p class="mb-0">This card is property of GHLK Health Care Center</p>
        </div>
      </div>

      <div class="text-center mt-4">
        <button onclick="downloadIDCard()" class="btn btn-success me-2">
          <i class="fas fa-download me-1"></i> Download
        </button>
        <button onclick="window.print()" class="btn btn-primary">
          <i class="fas fa-print me-1"></i> Print
        </button>
      </div>
    </div>

    <!-- QR Scanner Section -->
    <div id="scannerSection" class="form-container">
      <h3 class="text-center mb-4">
        <i class="fas fa-search me-2"></i> Patient Lookup
      </h3>

      <div class="mb-4">
        <div class="input-group">
          <input type="text" id="manualPatientId" class="form-control form-control-lg" placeholder="Enter Patient ID">
          <button id="searchPatientBtn" class="btn btn-primary">
            <i class="fas fa-search me-1"></i> Search
          </button>
        </div>

        <div class="d-flex align-items-center my-3">
          <hr class="flex-grow-1">
          <span class="mx-2">OR</span>
          <hr class="flex-grow-1">
        </div>

        <div id="qrScanner" style="width:100%;height:300px;border:2px dashed #ccc;margin-bottom:15px;"></div>

        <div class="text-center">
          <button id="startScanner" class="btn btn-primary me-2">
            <i class="fas fa-play me-1"></i> Start Scanner
          </button>
          <button id="stopScanner" class="btn btn-danger" style="display: none;">
            <i class="fas fa-stop me-1"></i> Stop Scanner
          </button>
        </div>

        <div id="scanResult" class="text-center fw-bold mt-3"></div>
      </div>
    </div>

    <!-- Attendance Form -->
    <div id="attendanceForm" class="form-container" style="display: none;">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
        onclick="hideForm('attendanceForm')"></button>
      <h3 class="text-center mb-4">
        <i class="fas fa-calendar-check me-2"></i> Patient Attendance
      </h3>

      <div class="row">
        <div class="col-md-6">
          <table class="table table-bordered">
            <tr>
              <th class="w-25">Patient ID</th>
              <td id="attendanceId">GHLK00001</td>
            </tr>
            <tr>
              <th>Name</th>
              <td id="attendanceName">John Doe</td>
            </tr>
            <tr>
              <th>Age</th>
              <td id="attendanceAge">30</td>
            </tr>
          </table>
        </div>
        <div class="col-md-6">
          <div class="text-center">
            <img id="attendancePhoto" src="" style="width:35mm;height:45mm;object-fit:cover;" class="border">
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="bedType" class="form-label">Bed Type</label>
        <select class="form-select" id="bedType">
          <option value="TM">TM</option>
          <option value="A700">A700</option>
          <option value="X-3">X-3</option>
        </select>
      </div>

      <h5 class="mt-4">Attendance History</h5>
      <div class="attendance-calendar" id="attendanceCalendar"></div>

      <div class="d-flex justify-content-between mt-4">
        <button id="editDetailsBtn" class="btn btn-warning">
          <i class="fas fa-edit me-1"></i> Edit Details
        </button>
        <button id="markAttendance" class="btn btn-success">
          <i class="fas fa-check-circle me-1"></i> Mark Attendance
        </button>
      </div>
    </div>

    <!-- Edit Form -->
    <div id="editForm" class="form-container" style="display: none;">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3" onclick="hideForm('editForm')"></button>
      <h3 class="text-center mb-4">
        <i class="fas fa-user-edit me-2"></i> Edit Patient Details
      </h3>
      <form id="edit-health-form">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="edit-name" class="form-label">Full Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="edit-name" name="edit-name" required>
            </div>

            <div class="mb-3">
              <label for="edit-age" class="form-label">Age <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="edit-age" name="edit-age" min="1" max="120" required>
            </div>

            <div class="mb-3">
              <label for="edit-address" class="form-label">Address</label>
              <textarea class="form-control" id="edit-address" name="edit-address" rows="2"></textarea>
            </div>

            <div class="mb-3">
              <label for="edit-contact_number" class="form-label">Contact Number <span
                  class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="edit-contact_number" name="edit-contact_number"
                pattern="[0-9]{10,15}" title="10-15 digit phone number" required>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label for="edit-gender" class="form-label">Gender <span class="text-danger">*</span></label>
              <select class="form-select" id="edit-gender" name="edit-gender" required>
                <option value="" selected disabled>Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Passport Photo (35mm x 45mm)</label>
              <div class="d-flex gap-2 mb-2">
                <button type="button" class="btn btn-outline-secondary" id="edit-takePhotoBtn">
                  <i class="fas fa-camera me-1"></i> Take Photo
                </button>
                <button type="button" class="btn btn-outline-secondary" id="edit-uploadPhoto">
                  <i class="fas fa-upload me-1"></i> Upload
                </button>
                <input type="file" id="edit-photoInput" accept="image/*" style="display: none;">
              </div>
              <video id="edit-video" playsinline style="display: none; width: 100%;"></video>
              <img id="edit-photoPreview" alt="Photo preview" class="d-block mx-auto">
              <button type="button" class="btn btn-outline-danger mt-2 mx-auto d-block" id="edit-retakePhoto"
                style="display: none;">
                <i class="fas fa-redo me-1"></i> Retake
              </button>
            </div>

            <div class="mb-3">
              <label for="edit-health_issues" class="form-label">Health Issues</label>
              <input type="text" class="form-control" id="edit-health_issues" name="edit-health_issues">
            </div>

            <div class="mb-3">
              <label for="edit-joining_date" class="form-label">Joining Date</label>
              <input type="date" class="form-control" id="edit-joining_date" name="edit-joining_date">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="edit-surgery" class="form-label">Surgery History</label>
              <input type="text" class="form-control" id="edit-surgery" name="edit-surgery">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="edit-paralysis_status" class="form-label">Paralysis Status</label>
              <select class="form-select" id="edit-paralysis_status" name="edit-paralysis_status">
                <option value="" selected>Select Status</option>
                <option value="None">None</option>
                <option value="Partial">Partial</option>
                <option value="Full">Full</option>
              </select>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="edit-other_details" class="form-label">Other Details</label>
          <textarea class="form-control" id="edit-other_details" name="edit-other_details" rows="2"></textarea>
        </div>

        <input type="hidden" id="edit-patientId">

        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-save me-1"></i> Update Details
          </button>
        </div>
      </form>
    </div>

    <!-- Patients Table -->
    <div id="patientsTable" class="form-container" style="display: none;">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
        onclick="hideForm('patientsTable')"></button>
      <h3 class="text-center mb-4">
        <i class="fas fa-users me-2"></i> Patient Records
      </h3>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Patient ID</th>
              <th>Name</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Contact</th>
              <th>Join Date</th>
              <th>Health Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="patientsTableBody">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Attendance Table -->
    <div id="attendanceTable" class="form-container" style="display: none;">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
        onclick="hideForm('attendanceTable')"></button>
      <h3 class="text-center mb-4">
        <i class="fas fa-calendar-alt me-2"></i> Attendance Records
      </h3>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Patient ID</th>
              <th>Name</th>
              <th>Date</th>
              <th>Bed Type</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Visitor View -->
    <div id="visitorView" class="form-container" style="display: none;">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
        onclick="hideForm('visitorView')"></button>
      <h3 class="text-center mb-4">
        <i class="fas fa-user me-2"></i> Patient Information
      </h3>

      <div class="row">
        <div class="col-md-4 text-center">
          <img id="visitorPhoto" alt="Patient Photo" style="width:35mm;height:45mm;object-fit:cover;"
            class="border mb-3">
        </div>
        <div class="col-md-8">
          <table class="table table-bordered">
            <tr>
              <th class="w-25">Patient ID</th>
              <td id="visitorId">GHLK00001</td>
            </tr>
            <tr>
              <th>Name</th>
              <td id="visitorName">John Doe</td>
            </tr>
            <tr>
              <th>Age</th>
              <td id="visitorAge">30</td>
            </tr>
            <tr>
              <th>Mobile</th>
              <td id="visitorMobile">+977 9876543210</td>
            </tr>
          </table>
        </div>
      </div>

      <h5 class="mt-4">Attendance History</h5>
      <div class="attendance-calendar" id="visitorAttendanceCalendar"></div>
    </div>

    <!-- Toast Notification -->
    <div class="toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3" role="alert"
      aria-live="assertive" aria-atomic="true" id="successToast">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-check-circle me-2"></i> <span id="successMessage">Operation completed successfully</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>

    <div class="toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-3" role="alert"
      aria-live="assertive" aria-atomic="true" id="errorToast">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-exclamation-circle me-2"></i> <span id="errorMessage">An error occurred</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script>
    // Main Application
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize Bootstrap components
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      const toastElList = [].slice.call(document.querySelectorAll('.toast'));
      const toastList = toastElList.map(function (toastEl) {
        return new bootstrap.Toast(toastEl, { autohide: true, delay: 5000 });
      });

      const successToast = new bootstrap.Toast(document.getElementById('successToast'));
      const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));

      // Global variables
      let patients = [];
      let attendanceRecords = [];
      let currentPatient = null;
      let scannerStream = null;
      let editStream = null;
      let isStaffLoggedIn = false;
      let patientCounter = 1;

      // Configuration
      const CONFIG = {
        PATIENT_ID_PREFIX: 'GHLK',
        BED_TYPES: ['TM', 'A700', 'X-3'],
        API_URL: 'https://script.google.com/macros/s/AKfycbxkkjFbpXr_61zmMgWnAg7FMHLrrrgiHxxEa7BWm3zSjKfRfgGHyKEyRjlxUVCrBFdn/exec' // Replace with your deployed Apps Script URL
      };

      // Initialize the application
      init();

      async function init() {
        await initData();
        initHomePage();
        initSystem();
      }

      // Initialize data from Google Sheets
      async function initData() {
        try {
          const result = await callAPI('getPatients');
          patients = result.data;
          if (patients.length > 0) {
            const lastId = patients[patients.length - 1].ID;
            patientCounter = parseInt(lastId.replace(CONFIG.PATIENT_ID_PREFIX, '')) + 1;
          }
        } catch (error) {
          console.error('Failed to load initial data:', error);
          showError('Failed to load initial data. Please refresh the page.');
        }
      }

      // Initialize homepage
      function initHomePage() {
        // Home Scan QR button
        document.getElementById('homeScanBtn').addEventListener('click', showVisitorScanner);

        // Home Login button - shows modal
        document.getElementById('homeLoginBtn').addEventListener('click', function (e) {
          e.preventDefault();
          const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
          loginModal.show();
        });

        // Staff Login Form
        document.getElementById('staffLoginForm').addEventListener('submit', async function (e) {
          e.preventDefault();
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          // Simple authentication (in real app, use proper authentication)
          if (username === 'admin' && password === 'admin123') {
            isStaffLoggedIn = true;
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.getElementById('loggedInUser').textContent = username;

            // Close modal
            const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            loginModal.hide();

            showSuccess('You are now logged in');
          } else {
            showError('Invalid username or password');
          }
        });
      }

      // Initialize system components
      function initSystem() {
        initRegistrationForm();
        initEditForm();
        initNavigation();
        initScannerSection();
      }

      // Initialize scanner section
      function initScannerSection() {
        // Manual ID search
        document.getElementById('searchPatientBtn').addEventListener('click', async function () {
          const patientId = document.getElementById('manualPatientId').value.trim();
          if (patientId) {
            try {
              const patient = await getPatient(patientId);
              currentPatient = patient;
              showAttendanceForm(patient);
            } catch (error) {
              showError('Patient not found');
            }
          }
        });

        // Also allow Enter key to search
        document.getElementById('manualPatientId').addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            document.getElementById('searchPatientBtn').click();
          }
        });

        // Initialize QR scanner buttons
        document.getElementById('startScanner').addEventListener('click', startScanner);
        document.getElementById('stopScanner').addEventListener('click', stopScanner);
      }

      // Show visitor scanner
      function showVisitorScanner() {
        const visitorModal = new bootstrap.Modal(document.getElementById('visitorScannerModal'));
        visitorModal.show();

        // Manual ID search for visitor
        document.getElementById('visitorSearchBtn').addEventListener('click', async function () {
          const patientId = document.getElementById('visitorManualId').value.trim();
          if (patientId) {
            try {
              const patient = await getPatient(patientId);
              visitorModal.hide();
              showVisitorPatientDetails(patient);
            } catch (error) {
              document.getElementById('visitorScanResult').textContent = 'Patient not found';
            }
          }
        });

        // Also allow Enter key to search
        document.getElementById('visitorManualId').addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            document.getElementById('visitorSearchBtn').click();
          }
        });

        // Initialize QR scanner for visitor
        const visitorQrScanner = document.getElementById('visitorQrScanner');
        const visitorScanResult = document.getElementById('visitorScanResult');
        let visitorStream = null;

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
          .then(function (stream) {
            visitorStream = stream;
            visitorQrScanner.innerHTML = '';
            const video = document.createElement('video');
            video.srcObject = stream;
            video.setAttribute('playsinline', 'true');
            video.style.width = '100%';
            video.style.height = '100%';
            visitorQrScanner.appendChild(video);
            video.play();

            // Start scanning
            scanVisitorQRCode(video);
          })
          .catch(function (err) {
            console.error("Error accessing camera: ", err);
            visitorScanResult.textContent = 'Error accessing camera';
          });
      }

      // Start QR scanner
      function startScanner() {
        const qrScanner = document.getElementById('qrScanner');
        const startScannerBtn = document.getElementById('startScanner');
        const stopScannerBtn = document.getElementById('stopScanner');

        qrScanner.style.display = 'block';
        startScannerBtn.style.display = 'none';
        stopScannerBtn.style.display = 'inline-block';
        document.getElementById('scanResult').textContent = 'Scanning...';

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
          .then(function (stream) {
            scannerStream = stream;
            qrScanner.innerHTML = '';
            const video = document.createElement('video');
            video.srcObject = stream;
            video.setAttribute('playsinline', 'true');
            video.style.width = '100%';
            video.style.height = '100%';
            qrScanner.appendChild(video);
            video.play();

            // Start scanning
            scanQRCode(video);
          })
          .catch(function (err) {
            console.error("Error accessing camera: ", err);
            document.getElementById('scanResult').textContent = 'Error accessing camera';
          });
      }

      // Stop QR scanner
      function stopScanner() {
        if (scannerStream) {
          scannerStream.getTracks().forEach(track => track.stop());
          scannerStream = null;
        }
        document.getElementById('qrScanner').style.display = 'none';
        document.getElementById('qrScanner').innerHTML = '';
        document.getElementById('startScanner').style.display = 'inline-block';
        document.getElementById('stopScanner').style.display = 'none';
        document.getElementById('scanResult').textContent = '';
      }

      // Show attendance form
      async function showAttendanceForm(patient) {
        document.getElementById('attendanceId').textContent = patient.ID;
        document.getElementById('attendanceName').textContent = patient.Name;
        document.getElementById('attendanceAge').textContent = patient.Age;
        document.getElementById('attendancePhoto').src = patient.PhotoUrl || '';

        // Generate attendance calendar
        try {
          const attendanceResult = await callAPI('getAttendance', { patientId: patient.ID });
          generateAttendanceCalendar(patient.ID, attendanceResult.data);
        } catch (error) {
          console.error('Failed to load attendance:', error);
        }

        document.getElementById('scannerSection').style.display = 'none';
        document.getElementById('attendanceForm').style.display = 'block';

        // Mark Attendance button
        document.getElementById('markAttendance').onclick = async function () {
          const bedType = document.getElementById('bedType').value;

          try {
            await callAPI('addAttendance', {
              patientId: patient.ID,
              patientName: patient.Name,
              bedType: bedType
            });

            // Refresh attendance data
            const attendanceResult = await callAPI('getAttendance', { patientId: patient.ID });
            generateAttendanceCalendar(patient.ID, attendanceResult.data);

            showSuccess(`Attendance marked for ${patient.Name}`);
          } catch (error) {
            console.error('Attendance marking failed:', error);
            showError('Failed to mark attendance');
          }
        };
      }

      // Show visitor patient details
      async function showVisitorPatientDetails(patient) {
        document.getElementById('visitorId').textContent = patient.ID;
        document.getElementById('visitorName').textContent = patient.Name;
        document.getElementById('visitorAge').textContent = patient.Age;
        document.getElementById('visitorMobile').textContent = patient.Phone;
        document.getElementById('visitorPhoto').src = patient.PhotoUrl || '';

        // Generate attendance calendar
        try {
          const attendanceResult = await callAPI('getAttendance', { patientId: patient.ID });
          generateVisitorAttendanceCalendar(patient.ID, attendanceResult.data);
        } catch (error) {
          console.error('Failed to load attendance:', error);
        }

        document.getElementById('visitorView').style.display = 'block';
      }

      // Initialize registration form
      function initRegistrationForm() {
        const photoPreview = document.getElementById('photoPreview');
        const photoInput = document.getElementById('photoInput');
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        let stream = null;

        // Take Photo button
        document.getElementById('takePhotoBtn').addEventListener('click', function () {
          video.style.display = 'block';
          photoPreview.style.display = 'none';
          document.getElementById('retakePhoto').style.display = 'none';

          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            })
              .then(function (mediaStream) {
                stream = mediaStream;
                video.srcObject = mediaStream;
                video.play();
              })
              .catch(function (error) {
                showError('Could not access the camera: ' + error.message);
              });
          } else {
            showError('Camera access not supported in this browser');
          }
        });

        // Capture photo from camera
        video.addEventListener('click', function () {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

          // Crop to passport size
          const croppedDataUrl = cropToPassportSize(canvas);
          photoPreview.src = croppedDataUrl;

          // Stop camera stream
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }

          video.style.display = 'none';
          photoPreview.style.display = 'block';
          document.getElementById('retakePhoto').style.display = 'block';
        });

        // Retake photo
        document.getElementById('retakePhoto').addEventListener('click', function () {
          photoPreview.style.display = 'none';
          document.getElementById('takePhotoBtn').click();
        });

        // Upload photo from file
        document.getElementById('uploadPhoto').addEventListener('click', function () {
          photoInput.click();
        });

        photoInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = new Image();
              img.onload = function () {
                const imgCanvas = document.createElement('canvas');
                imgCanvas.width = img.width;
                imgCanvas.height = img.height;
                const ctx = imgCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const croppedDataUrl = cropToPassportSize(imgCanvas);
                photoPreview.src = croppedDataUrl;
                photoPreview.style.display = 'block';
                document.getElementById('retakePhoto').style.display = 'block';
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

        // Form submission
        document.getElementById('health-form').addEventListener('submit', async function (e) {
          e.preventDefault();

          const patientData = {
            name: document.getElementById('name').value,
            age: document.getElementById('age').value,
            address: document.getElementById('address').value,
            phone: document.getElementById('contact_number').value,
            gender: document.getElementById('gender').value,
            healthIssues: document.getElementById('health_issues').value,
            surgery: document.getElementById('surgery').value,
            paralysisStatus: document.getElementById('paralysis_status').value,
            otherDetails: document.getElementById('other_details').value,
            joiningDate: document.getElementById('joining_date').value,
            photoUrl: document.getElementById('photoPreview').src || ''
          };

          try {
            const result = await callAPI('addPatient', patientData);
            const patientId = result.patientId;

            // Refresh patient list
            const patientsResult = await callAPI('getPatients');
            patients = patientsResult.data;

            // Update ID Card
            const patient = await getPatient(patientId);
            updateIDCard(patient);

            // Show ID card
            hideAllForms();
            document.getElementById('idCardContainer').style.display = 'block';

            // Reset form
            e.target.reset();
            photoPreview.style.display = 'none';
            photoPreview.src = '';
            document.getElementById('retakePhoto').style.display = 'none';

            showSuccess('Patient registered successfully!');
          } catch (error) {
            console.error('Registration failed:', error);
            showError('Failed to register patient: ' + error.message);
          }
        });
      }

      // Initialize edit form
      function initEditForm() {
        const photoPreview = document.getElementById('edit-photoPreview');
        const photoInput = document.getElementById('edit-photoInput');
        const video = document.getElementById('edit-video');
        const canvas = document.createElement('canvas');
        let stream = null;

        // Take Photo button
        document.getElementById('edit-takePhotoBtn').addEventListener('click', function () {
          video.style.display = 'block';
          photoPreview.style.display = 'none';
          document.getElementById('edit-retakePhoto').style.display = 'none';

          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            })
              .then(function (mediaStream) {
                stream = mediaStream;
                video.srcObject = mediaStream;
                video.play();
              })
              .catch(function (error) {
                showError('Could not access the camera: ' + error.message);
              });
          } else {
            showError('Camera access not supported in this browser');
          }
        });

        // Capture photo from camera
        video.addEventListener('click', function () {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

          // Crop to passport size
          const croppedDataUrl = cropToPassportSize(canvas);
          photoPreview.src = croppedDataUrl;

          // Stop camera stream
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }

          video.style.display = 'none';
          photoPreview.style.display = 'block';
          document.getElementById('edit-retakePhoto').style.display = 'block';
        });

        // Retake photo
        document.getElementById('edit-retakePhoto').addEventListener('click', function () {
          photoPreview.style.display = 'none';
          document.getElementById('edit-takePhotoBtn').click();
        });

        // Upload photo from file
        document.getElementById('edit-uploadPhoto').addEventListener('click', function () {
          photoInput.click();
        });

        photoInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = new Image();
              img.onload = function () {
                const imgCanvas = document.createElement('canvas');
                imgCanvas.width = img.width;
                imgCanvas.height = img.height;
                const ctx = imgCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const croppedDataUrl = cropToPassportSize(imgCanvas);
                photoPreview.src = croppedDataUrl;
                photoPreview.style.display = 'block';
                document.getElementById('edit-retakePhoto').style.display = 'block';
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

        // Edit form submission
        document.getElementById('edit-health-form').addEventListener('submit', async function (e) {
          e.preventDefault();

          const patientData = {
            id: document.getElementById('edit-patientId').value,
            Name: document.getElementById('edit-name').value,
            Age: document.getElementById('edit-age').value,
            Address: document.getElementById('edit-address').value,
            Phone: document.getElementById('edit-contact_number').value,
            Gender: document.getElementById('edit-gender').value,
            JoiningDate: document.getElementById('edit-joining_date').value,
            HealthIssues: document.getElementById('edit-health_issues').value,
            Surgery: document.getElementById('edit-surgery').value,
            ParalysisStatus: document.getElementById('edit-paralysis_status').value,
            OtherDetails: document.getElementById('edit-other_details').value,
            PhotoUrl: document.getElementById('edit-photoPreview').src || ''
          };

          try {
            await callAPI('updatePatient', patientData);

            // Refresh patient list
            const patientsResult = await callAPI('getPatients');
            patients = patientsResult.data;

            // Update current patient if we're editing the same one
            if (currentPatient && currentPatient.ID === patientData.id) {
              currentPatient = await getPatient(patientData.id);
            }

            // Hide edit form
            document.getElementById('editForm').style.display = 'none';

            showSuccess('Patient details updated successfully!');
          } catch (error) {
            console.error('Update failed:', error);
            showError('Failed to update patient: ' + error.message);
          }
        });

        // Edit Details button in attendance form
        document.getElementById('editDetailsBtn').addEventListener('click', async function () {
          if (currentPatient) {
            try {
              const patient = await getPatient(currentPatient.ID);
              loadPatientIntoEditForm(patient);
              document.getElementById('attendanceForm').style.display = 'none';
              document.getElementById('editForm').style.display = 'block';
            } catch (error) {
              showError('Failed to load patient details');
            }
          }
        });
      }

      // Initialize navigation
      function initNavigation() {
        // Show Registration Form
        document.getElementById('showRegistrationBtn').addEventListener('click', function () {
          hideAllForms();
          document.getElementById('registrationForm').style.display = 'block';
        });

        // Show Patients Table
        document.getElementById('showPatientsBtn').addEventListener('click', async function () {
          hideAllForms();
          document.getElementById('patientsTable').style.display = 'block';
          await updatePatientsTable();
        });

        // Show Attendance Table
        document.getElementById('showAttendanceBtn').addEventListener('click', async function () {
          hideAllForms();
          document.getElementById('attendanceTable').style.display = 'block';
          await updateAttendanceTable();
        });

        // Show QR Scanner
        document.getElementById('scanQrBtn').addEventListener('click', function () {
          hideAllForms();
          document.getElementById('scannerSection').style.display = 'block';
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', function () {
          isStaffLoggedIn = false;
          document.getElementById('mainSystem').style.display = 'none';
          document.getElementById('homePage').style.display = 'block';

          // Stop any active scanner
          if (scannerStream) {
            scannerStream.getTracks().forEach(track => track.stop());
            scannerStream = null;
          }

          // Clear forms
          document.getElementById('health-form').reset();
          document.getElementById('edit-health-form').reset();

          showSuccess('You have been successfully logged out');
        });
      }

      // Scan QR code
      function scanQRCode(video) {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        function tick() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "dontInvert",
            });

            if (code) {
              const patientId = code.data;
              getPatient(patientId)
                .then(patient => {
                  currentPatient = patient;
                  showAttendanceForm(patient);

                  // Keep scanning after showing form
                  setTimeout(() => {
                    document.getElementById('scanResult').textContent = 'Scanning...';
                    tick();
                  }, 3000);
                })
                .catch(() => {
                  document.getElementById('scanResult').textContent = 'Patient not found';
                  setTimeout(() => {
                    document.getElementById('scanResult').textContent = 'Scanning...';
                    tick();
                  }, 2000);
                });
            } else {
              requestAnimationFrame(tick);
            }
          } else {
            requestAnimationFrame(tick);
          }
        }

        tick();
      }

      // Scan visitor QR code
      function scanVisitorQRCode(video) {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        function tick() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "dontInvert",
            });

            if (code) {
              const patientId = code.data;
              getPatient(patientId)
                .then(patient => {
                  document.getElementById('visitorScanResult').textContent = `Patient Found: ${patient.Name}`;
                  const visitorModal = bootstrap.Modal.getInstance(document.getElementById('visitorScannerModal'));
                  visitorModal.hide();
                  showVisitorPatientDetails(patient);
                })
                .catch(() => {
                  document.getElementById('visitorScanResult').textContent = 'Patient not found';
                  setTimeout(() => {
                    document.getElementById('visitorScanResult').textContent = 'Scanning...';
                    tick();
                  }, 2000);
                });
            } else {
              requestAnimationFrame(tick);
            }
          } else {
            requestAnimationFrame(tick);
          }
        }

        tick();
      }

      // Generate attendance calendar
      function generateAttendanceCalendar(patientId, attendanceRecords) {
        const calendar = document.getElementById('attendanceCalendar');
        calendar.innerHTML = '';

        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        // Add month header
        const monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        // Add day headers
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        dayNames.forEach(day => {
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day fw-bold';
          dayElement.textContent = day;
          calendar.appendChild(dayElement);
        });

        // Add empty days for start of month
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day';
          calendar.appendChild(emptyDay);
        }

        // Add days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const attendance = attendanceRecords.find(ar =>
            ar.PatientID === patientId && ar.Date === dateStr
          );

          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          dayElement.textContent = day;

          if (attendance) {
            dayElement.classList.add('present');
            dayElement.title = `Bed: ${attendance.BedType}`;
          } else if (day < today.getDate() && currentMonth === today.getMonth()) {
            dayElement.classList.add('absent');
          }

          calendar.appendChild(dayElement);
        }
      }

      // Generate visitor attendance calendar
      function generateVisitorAttendanceCalendar(patientId, attendanceRecords) {
        const calendar = document.getElementById('visitorAttendanceCalendar');
        calendar.innerHTML = '';

        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        // Add day headers
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        dayNames.forEach(day => {
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day fw-bold';
          dayElement.textContent = day;
          calendar.appendChild(dayElement);
        });

        // Add empty days for start of month
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day';
          calendar.appendChild(emptyDay);
        }

        // Add days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const attendance = attendanceRecords.find(ar =>
            ar.PatientID === patientId && ar.Date === dateStr
          );

          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          dayElement.textContent = day;

          if (attendance) {
            dayElement.classList.add('present');
            dayElement.title = `Bed: ${attendance.BedType}`;
          } else if (day < today.getDate() && currentMonth === today.getMonth()) {
            dayElement.classList.add('absent');
          }

          calendar.appendChild(dayElement);
        }
      }

      // Load patient into edit form
      function loadPatientIntoEditForm(patient) {
        document.getElementById('edit-patientId').value = patient.ID;
        document.getElementById('edit-name').value = patient.Name;
        document.getElementById('edit-age').value = patient.Age;
        document.getElementById('edit-address').value = patient.Address;
        document.getElementById('edit-contact_number').value = patient.Phone;
        document.getElementById('edit-gender').value = patient.Gender;
        document.getElementById('edit-joining_date').value = patient.JoiningDate;
        document.getElementById('edit-health_issues').value = patient.HealthIssues;
        document.getElementById('edit-surgery').value = patient.Surgery;
        document.getElementById('edit-paralysis_status').value = patient.ParalysisStatus;
        document.getElementById('edit-other_details').value = patient.OtherDetails;

        if (patient.PhotoUrl) {
          document.getElementById('edit-photoPreview').src = patient.PhotoUrl;
          document.getElementById('edit-photoPreview').style.display = 'block';
        } else {
          document.getElementById('edit-photoPreview').style.display = 'none';
        }
      }

      // Get patient by ID
      async function getPatient(patientId) {
        try {
          const result = await callAPI('getPatient', { patientId });
          return result.data;
        } catch (error) {
          console.error('Failed to get patient:', error);
          throw error;
        }
      }

      // Update patients table
      async function updatePatientsTable() {
        try {
          const result = await callAPI('getPatients');
          patients = result.data;

          const tableBody = document.getElementById('patientsTableBody');
          tableBody.innerHTML = '';

          patients.forEach(patient => {
            const row = document.createElement('tr');
            row.dataset.id = patient.ID;

            row.innerHTML = `
              <td>${patient.ID}</td>
              <td>${patient.Name}</td>
              <td>${patient.Age}</td>
              <td>${patient.Gender}</td>
              <td>${patient.Phone}</td>
              <td>${patient.JoiningDate}</td>
              <td>${patient.HealthIssues || 'N/A'}</td>
              <td>
                <button class="btn btn-sm btn-info view-patient" title="View">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            `;

            tableBody.appendChild(row);
          });

          // Add click handlers for view buttons
          document.querySelectorAll('.view-patient').forEach(button => {
            button.addEventListener('click', async function () {
              const patientId = this.closest('tr').dataset.id;
              try {
                const patient = await getPatient(patientId);
                updateIDCard(patient);
                hideAllForms();
                document.getElementById('idCardContainer').style.display = 'block';
              } catch (error) {
                showError('Failed to load patient details');
              }
            });
          });
        } catch (error) {
          console.error('Failed to update patients table:', error);
          showError('Failed to load patients');
        }
      }

      // Update attendance table
      async function updateAttendanceTable() {
        try {
          const result = await callAPI('getAllAttendance');
          attendanceRecords = result.data;

          const tableBody = document.getElementById('attendanceTableBody');
          tableBody.innerHTML = '';

          attendanceRecords.forEach(record => {
            const row = document.createElement('tr');

            row.innerHTML = `
              <td>${record.PatientID}</td>
              <td>${record.PatientName}</td>
              <td>${record.Date}</td>
              <td>${record.BedType}</td>
              <td><span class="badge bg-success">${record.Status}</span></td>
            `;

            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error('Failed to update attendance table:', error);
          showError('Failed to load attendance records');
        }
      }

      // Update ID card
      function updateIDCard(patient) {
        document.getElementById('idCardName').textContent = patient.Name;
        document.getElementById('idCardAge').textContent = patient.Age;
        document.getElementById('idCardAddress').textContent = patient.Address;
        document.getElementById('idCardMobile').textContent = patient.Phone;
        document.getElementById('idCardJoiningDate').textContent = patient.JoiningDate;
        document.getElementById('idCardPatientId').textContent = patient.ID;

        // Update QR code with patient ID
        document.getElementById('qrCode').src =
          `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${patient.ID}`;

        // Show photo in ID card if available
        if (patient.PhotoUrl) {
          document.getElementById('idCardPhoto').src = patient.PhotoUrl;
          document.getElementById('idCardPhoto').style.display = 'block';
        } else {
          document.getElementById('idCardPhoto').style.display = 'none';
        }
      }

      // Crop image to passport size
      function cropToPassportSize(sourceCanvas) {
        const passportRatio = 35 / 45;
        const sourceRatio = sourceCanvas.width / sourceCanvas.height;

        let sx, sy, sWidth, sHeight;

        if (sourceRatio > passportRatio) {
          // Source is wider than passport ratio
          sWidth = sourceCanvas.height * passportRatio;
          sHeight = sourceCanvas.height;
          sx = (sourceCanvas.width - sWidth) / 2;
          sy = 0;
        } else {
          // Source is taller than passport ratio
          sWidth = sourceCanvas.width;
          sHeight = sourceCanvas.width / passportRatio;
          sx = 0;
          sy = (sourceCanvas.height - sHeight) / 2;
        }

        // Create passport size canvas (35mm x 45mm at 10px/mm)
        const passportCanvas = document.createElement('canvas');
        passportCanvas.width = 350;
        passportCanvas.height = 450;
        passportCanvas.getContext('2d').drawImage(
          sourceCanvas,
          sx, sy, sWidth, sHeight,
          0, 0, passportCanvas.width, passportCanvas.height
        );

        return passportCanvas.toDataURL('image/jpeg', 0.8);
      }

      // Download ID card
      function downloadIDCard() {
        html2canvas(document.getElementById('idCard'), {
          scale: 2,
          logging: false,
          useCORS: true,
          allowTaint: true
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = `GHLK_ID_${document.getElementById('idCardPatientId').textContent}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      }

      // Hide all form containers
      function hideAllForms() {
        document.querySelectorAll('.form-container').forEach(container => {
          container.style.display = 'none';
        });
      }

      // Hide specific form
      function hideForm(formId) {
        document.getElementById(formId).style.display = 'none';
      }

      // Call API
      async function callAPI(action, data = {}) {
        try {
          const response = await fetch(CONFIG.API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: action,
              data: data
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.status === 'error') {
            throw new Error(result.message || 'Unknown error from server');
          }

          return result;
        } catch (error) {
          console.error('API Error:', error);
          throw error;
        }
      }

      // Show success message
      function showSuccess(message) {
        document.getElementById('successMessage').textContent = message;
        const successToast = bootstrap.Toast.getInstance(document.getElementById('successToast'));
        successToast.show();
      }

      // Show error message
      function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        const errorToast = bootstrap.Toast.getInstance(document.getElementById('errorToast'));
        errorToast.show();
      }
    });
  </script>
</body>

</html>