<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com 'nonce-ghlk';
        style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
        font-src https://fonts.gstatic.com;
        img-src 'self' data: https://placehold.co https://api.qrserver.com;
        media-src 'self';
        connect-src 'self' https://script.google.com https://accounts.google.com;
        frame-src 'none';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <title>GHLK Patient Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        th { background-color: #e5e7eb; cursor: pointer; }
        th:hover { background-color: #d1d5db; }
        canvas { max-width: 100%; height: auto; }
        .hidden { display: none; }
        #qrVideo, #patientQrVideo { width: 100%; max-width: 300px; margin: 1rem auto; }
        #scanner-output, #patient-scanner-output { margin-top: 10px; font-weight: bold; text-align: center; color: #4CAF50; }
        .error { color: #F44336; }
        input:invalid:focus, select:invalid:focus, textarea:invalid:focus { border-color: #F44336; }
        button:hover { transition: background-color 0.2s ease; }
        .field-error { display: none; color: #F44336; font-size: 0.875rem; margin-top: 0.25rem; }
        .table-responsive { overflow-x: auto; }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 1rem; border-radius: 0.5rem; z-index: 1000; }
        #idCard { width: 350px; height: 220px; background: #ffffff; padding: 20px; border: 2px solid #333; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin: 20px auto; }
        .company-info { text-align: center; margin-bottom: 10px; }
        .company-info h2 { margin: 0; font-size: 18px; }
        .company-info p { margin: 0; font-size: 12px; color: #555; }
        .info-section { display: flex; justify-content: space-between; }
        .details { font-size: 14px; line-height: 1.6; }
        .details div { display: flex; }
        .details b { width: 100px; }
        .qr-section { margin-left: 10px; }
        .qr-section img { width: 80px; height: 80px; }
        .navbar { background-color: #10B981; padding: 1rem; }
        .navbar-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
        .navbar-logo { display: flex; align-items: center; }
        .navbar-logo img { height: 40px; margin-right: 1rem; }
        .navbar-logo h1 { color: white; font-size: 1.5rem; margin: 0; }
        .navbar-buttons { display: flex; gap: 1rem; }
        @media (max-width: 640px) {
            .navbar-container { flex-direction: column; align-items: flex-start; }
            .navbar-buttons { margin-top: 1rem; }
            #qrVideo, #patientQrVideo { max-width: 100%; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <img src="https://placehold.co/40x40?text=GHLK" alt="GHLK Logo">
                <h1>GHLK Patient Management System</h1>
            </div>
            <div class="navbar-buttons">
                <button id="loginButton" class="bg-white text-green-600 font-semibold py-2 px-4 rounded-md hover:bg-gray-100" aria-label="Staff Login">Login</button>
                <button id="patientQrButton" class="bg-white text-green-600 font-semibold py-2 px-4 rounded-md hover:bg-gray-100" aria-label="Scan QR Code">Scan QR</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div id="loginSection" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Staff Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Username">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Password">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700" aria-label="Login">Login</button>
            </form>
            <p id="loginError" class="text-red-500 mt-2 hidden">Invalid username or password</p>
        </div>

        <div id="patientQrSection" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Scan Your Patient ID</h2>
            <div id="patientQrVideo"></div>
            <div id="patient-scanner-output"></div>
            <div class="flex justify-center space-x-4 mb-4">
                <button id="startScannerPatient" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700" aria-label="Start QR scanner">Start QR Scanner</button>
                <button id="stopScannerPatient" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 hidden" aria-label="Stop QR scanner">Stop QR Scanner</button>
            </div>
            <div id="patientInfo" class="mt-4 hidden">
                <h3 class="text-lg font-semibold mb-2">Patient Information</h3>
                <div id="patientInfoDetails" class="text-gray-700"></div>
            </div>
        </div>

        <div id="staffDashboard" class="hidden">
            <div class="flex justify-end mb-4">
                <button id="logoutButton" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700" aria-label="Logout">Logout</button>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <button id="showRegisterForm" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700" aria-label="Register new patient">Register New Patient</button>
            </div>

            <div id="registerSection" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Register New Patient</h2>
                <form id="patientForm" class="space-y-4" novalidate>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" pattern="[A-Za-z\s]+" aria-label="Patient name">
                            <p id="nameError" class="field-error">Letters and spaces only</p>
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                            <input type="text" id="address" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient address">
                            <p id="addressError" class="field-error">Address is required</p>
                        </div>
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                            <input type="number" id="age" required min="0" max="120" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient age">
                            <p id="ageError" class="field-error">Age must be 0-120</p>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input type="tel" id="phone" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" pattern="[0-9\s\-\+\(\)]+" aria-label="Patient phone number">
                            <p id="phoneError" class="field-error">Numbers, spaces, +, -, or () only</p>
                        </div>
                        <div>
                            <label for="joiningDate" class="block text-sm font-medium text-gray-700">Joining Date</label>
                            <input type="date" id="joiningDate" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Joining date">
                            <p id="joiningDateError" class="field-error">Valid date required (not in future)</p>
                        </div>
                    </div>
                    <div>
                        <label for="healthIssues" class="block text-sm font-medium text-gray-700">Health Issues</label>
                        <textarea id="healthIssues" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient health issues"></textarea>
                        <p id="healthIssuesError" class="field-error">Health issues are required</p>
                    </div>
                    <div>
                        <label for="surgery" class="block text-sm font-medium text-gray-700">Surgery History</label>
                        <textarea id="surgery" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient surgery history"></textarea>
                    </div>
                    <div>
                        <label for="paralysisStatus" class="block text-sm font-medium text-gray-700">Paralysis Status</label>
                        <select id="paralysisStatus" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient paralysis status">
                            <option value="None">None</option>
                            <option value="Partial">Partial</option>
                            <option value="Full">Paralysis</option>
                        </select>
                        <p id="paralysisStatusError" class="field-error">Please select a status</p>
                    </div>
                    <div>
                        <label for="otherDetails" class="block text-sm font-medium text-gray-700">Other Details</label>
                        <textarea id="otherDetails" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Other patient details"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700" aria-label="Register patient">Register Patient</button>
                </form>
                <div id="idCardSection" class="hidden mt-4">
                    <h3 class="text-lg font-semibold mb-2">Patient ID Card</h3>
                    <div id="idCard" class="mx-auto"></div>
                    <div class="flex justify-center space-x-4 mt-4">
                        <button id="downloadCard" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700" aria-label="Download ID card">Download ID Card</button>
                        <button id="closeCard" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700" aria-label="Close ID card">Close</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Attendance & Bed Management</h2>
                <div id="qrScannerSection">
                    <p class="text-gray-700 mb-2">Scan QR Code or Enter Patient ID</p>
                    <div id="qrVideo"></div>
                    <div id="scanner-output"></div>
                    <div class="flex justify-center space-x-4 mb-4">
                        <button id="startScanner" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700" aria-label="Start QR scanner">Start QR Scanner</button>
                        <button id="stopScanner" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 hidden" aria-label="Stop QR scanner">Stop QR Scanner</button>
                    </div>
                    <div>
                        <label for="patientId" class="block text-sm font-medium text-gray-700">Patient ID</label>
                        <input type="text" id="patientId" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" pattern="GHLK\d{4}" aria-label="Patient ID">
                        <p id="patientIdError" class="field-error">Format: GHLK followed by 4 digits</p>
                    </div>
                    <button id="checkId" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 mt-4" aria-label="Check patient ID">Check ID</button>
                    <p id="noDetails" class="text-red-500 mt-2 hidden">No patient found for this ID</p>
                </div>
                <div id="patientDetailsSection" class="mt-4 hidden">
                    <h3 class="text-lg font-semibold mb-2">Patient Details</h3>
                    <div id="patientDetails" class="text-gray-700"></div>
                    <div class="flex justify-start space-x-4 mt-4">
                        <button id="editDetailsButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700" aria-label="Edit patient details">Edit Details</button>
                    </div>
                    <div id="editPatientSection" class="mt-4 hidden">
                        <h3 class="text-lg font-semibold mb-2">Edit Patient Details</h3>
                        <form id="editPatientForm" class="space-y-4" novalidate>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="editId" class="block text-sm font-medium text-gray-700">Patient ID (Read-only)</label>
                                    <input type="text" id="editId" readonly class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-gray-100" aria-label="Patient ID">
                                </div>
                                <div>
                                    <label for="editName" class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" id="editName" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" pattern="[A-Za-z\s]+" aria-label="Patient name">
                                    <p id="editNameError" class="field-error">Letters and spaces only</p>
                                </div>
                                <div>
                                    <label for="editAddress" class="block text-sm font-medium text-gray-700">Address</label>
                                    <input type="text" id="editAddress" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient address">
                                    <p id="editAddressError" class="field-error">Address is required</p>
                                </div>
                                <div>
                                    <label for="editAge" class="block text-sm font-medium text-gray-700">Age</label>
                                    <input type="number" id="editAge" required min="0" max="120" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient age">
                                    <p id="editAgeError" class="field-error">Age must be 0-120</p>
                                </div>
                                <div>
                                    <label for="editPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                    <input type="tel" id="editPhone" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" pattern="[0-9\s\-\+\(\)]+" aria-label="Patient phone number">
                                    <p id="editPhoneError" class="field-error">Numbers, spaces, +, -, or () only</p>
                                </div>
                                <div>
                                    <label for="editJoiningDate" class="block text-sm font-medium text-gray-700">Joining Date</label>
                                    <input type="date" id="editJoiningDate" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Joining date">
                                    <p id="editJoiningDateError" class="field-error">Valid date required (not in future)</p>
                                </div>
                            </div>
                            <div>
                                <label for="editHealthIssues" class="block text-sm font-medium text-gray-700">Health Issues</label>
                                <textarea id="editHealthIssues" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient health issues"></textarea>
                                <p id="editHealthIssuesError" class="field-error">Health issues are required</p>
                            </div>
                            <div>
                                <label for="editSurgery" class="block text-sm font-medium text-gray-700">Surgery History</label>
                                <textarea id="editSurgery" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient surgery history"></textarea>
                            </div>
                            <div>
                                <label for="editParalysisStatus" class="block text-sm font-medium text-gray-700">Paralysis Status</label>
                                <select id="editParalysisStatus" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Patient paralysis status">
                                    <option value="None">None</option>
                                    <option value="Partial">Partial</option>
                                    <option value="Full">Paralysis</option>
                                </select>
                                <p id="editParalysisStatusError" class="field-error">Please select a status</p>
                            </div>
                            <div>
                                <label for="editOtherDetails" class="block text-sm font-medium text-gray-700">Other Details</label>
                                <textarea id="editOtherDetails" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Other patient details"></textarea>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700" aria-label="Save changes">Save Changes</button>
                                <button type="button" id="cancelEdit" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700" aria-label="Cancel edit">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <h3 class="text-lg font-semibold mt-4 mb-2">Update Attendance & Status</h3>
                    <form id="attendanceForm" class="space-y-4" novalidate>
                        <div>
                            <label for="bedNumber" class="block text-sm font-medium text-gray-700">Bed Number</label>
                            <input type="number" id="bedNumber" min="0" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Bed number">
                        </div>
                        <div>
                            <label for="healthStatus" class="block text-sm font-medium text-gray-700">Health Status</label>
                            <select id="healthStatus" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Health status">
                                <option value="Stable">Stable</option>
                                <option value="Improving">Improving</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700" aria-label="Mark attendance">Mark Attendance</button>
                    </form>
                    <h3 class="text-lg font-semibold mt-4 mb-2">Past Attendance Records</h3>
                    <table id="patientAttendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Bed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Patient List</h2>
                <div class="table-responsive">
                    <table id="patientTable">
                        <thead>
                            <tr>
                                <th data-sort="id">ID</th>
                                <th data-sort="name">Name</th>
                                <th>Address</th>
                                <th>Age</th>
                                <th>Phone</th>
                                <th>Health Issues</th>
                                <th>Paralysis Status</th>
                                <th>Surgery</th>
                                <th>Other Details</th>
                                <th>Joining Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Attendance Records</h2>
                <div class="table-responsive">
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient ID</th>
                                <th>Name</th>
                                <th>Bed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Health Status Trends</h2>
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div id="publicSection" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">About GHLK</h2>
            <p class="text-gray-700 mb-4">Green and Happy Life Korea (GHLK) provides thermal therapy and fitness programs to improve health and mobility in Rampur, Palpa, Nepal.</p>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Submit a Review</h2>
            <form id="reviewForm" class="space-y-4" novalidate>
                <div>
                    <label for="reviewName" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="reviewName" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" pattern="[A-Za-z\s\.\-]+" aria-label="Reviewer name">
                    <p id="reviewNameError" class="field-error">Letters, spaces, dots, or hyphens only</p>
                </div>
                <div>
                    <label for="reviewText" class="block text-sm font-medium text-gray-700">Review</label>
                    <textarea id="reviewText" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-none focus:border-gray-300" aria-label="Review text"></textarea>
                    <p id="reviewTextError" class="field-error">Review text is required</p>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700" aria-label="Submit review">Submit Review</button>
            </form>
            <button id="testApi" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 mt-4" aria-label="Test API">Test API</button>
            <h2 class="text-xl font-semibold mt-6 mb-4 text-gray-800">Reviews</h2>
            <div id="reviewList" class="space-y-4"></div>
        </div>
    </div>

    <script nonce="ghlk">
        // Google Apps Script Web App URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbzoH9Sa4EBrva--Qm2jC4PEGVZxkeEUQYVROIqfc6NVMOtLzVCvuKOWe9ub4iMDcVKFRw/exec';

        // Mock credentials (demo only; use server-side auth in production)
        const staffCredentials = [
            { username: 'staff1', passwordHash: 'ghlk123' },
            { username: 'admin', passwordHash: 'ghlkadmin' }
        ];

        // DOM elements
        const elements = {
            patientForm: document.getElementById('patientForm'),
            registerSection: document.getElementById('registerSection'),
            showRegisterForm: document.getElementById('showRegisterForm'),
            scannerOutput: document.getElementById('scanner-output'),
            patientScannerOutput: document.getElementById('patient-scanner-output'),
            startScanner: document.getElementById('startScanner'),
            stopScanner: document.getElementById('stopScanner'),
            startScannerPatient: document.getElementById('startScannerPatient'),
            stopScannerPatient: document.getElementById('stopScannerPatient'),
            idCardSection: document.getElementById('idCardSection'),
            idCard: document.getElementById('idCard'),
            downloadCard: document.getElementById('downloadCard'),
            closeCard: document.getElementById('closeCard'),
            loginButton: document.getElementById('loginButton'),
            loginSection: document.getElementById('loginSection'),
            patientQrSection: document.getElementById('patientQrSection'),
            patientQrButton: document.getElementById('patientQrButton'),
            staffDashboard: document.getElementById('staffDashboard'),
            publicSection: document.getElementById('publicSection'),
            editDetailsButton: document.getElementById('editDetailsButton'),
            editPatientSection: document.getElementById('editPatientSection'),
            editPatientForm: document.getElementById('editPatientForm'),
            cancelEdit: document.getElementById('cancelEdit'),
            attendanceForm: document.getElementById('attendanceForm'),
            reviewForm: document.getElementById('reviewForm'),
            testApi: document.getElementById('testApi')
        };

        // QR Scanner instances
        let html5QrCode = null; // Staff scanner
        let patientQrCode = null; // Patient scanner

        // XSS sanitization
        function sanitize(input) {
            if (typeof input !== 'string') return input;
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.backgroundColor = isError ? '#F44336' : '#4CAF50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Clear form errors
        function clearFormErrors(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            form.querySelectorAll('.field-error').forEach(error => error.style.display = 'none');
            form.querySelectorAll('input, select, textarea').forEach(input => input.classList.remove('border-red-500'));
        }

        // Show form error
        function showFormError(inputId, errorId) {
            const input = document.getElementById(inputId);
            const error = document.getElementById(errorId);
            if (input && error) {
                error.style.display = 'block';
                input.classList.add('border-red-500');
            }
        }

        // Generate ID Card
        function generateIdCard(patient) {
            console.log('Generating ID card for:', patient);
            elements.idCard.innerHTML = `
                <div class="company-info">
                    <h2>GHLK Health Care Center</h2>
                    <p>Rampur, Palpa, Nepal</p>
                </div>
                <div class="info-section">
                    <div class="details">
                        <div><b>Patient ID:</b> ${sanitize(patient.id)}</div>
                        <div><b>Name:</b> ${sanitize(patient.name)}</div>
                        <div><b>Age:</b> ${sanitize(patient.age.toString())}</div>
                        <div><b>Address:</b> ${sanitize(patient.address)}</div>
                        <div><b>Mobile No:</b> ${sanitize(patient.phone)}</div>
                        <div><b>Join Date:</b> ${sanitize(patient.joiningDate)}</div>
                    </div>
                    <div class="qr-section">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(patient.id)}" alt="QR Code" width="80" height="80">
                    </div>
                </div>
            `;
            elements.idCardSection.classList.remove('hidden');
        }

        // Download ID Card
        function initIdCardButtons(patient) {
            elements.downloadCard.addEventListener('click', () => {
                console.log('Downloading ID card for:', patient.id);
                html2canvas(elements.idCard).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `IDCard_${patient.id}.png`;
                    link.click();
                });
            }, { once: true });
            elements.closeCard.addEventListener('click', () => {
                console.log('Closing ID card section');
                elements.idCardSection.classList.add('hidden');
                elements.registerSection.classList.add('hidden');
                elements.showRegisterForm.parentElement.classList.remove('hidden');
            }, { once: true });
        }

        // API Request Helper
        async function apiRequest(action, data) {
            try {
                console.log('API Request:', { action, data });
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data })
                });
                console.log('Response status:', response.status, response.statusText);
                const text = await response.text();
                console.log('Raw response:', text);
                let result;
                try {
                    result = JSON.parse(text);
                } catch (err) {
                    throw new Error('Invalid JSON response: ' + text);
                }
                if (result.status !== 'success') {
                    throw new Error(result.message || 'API request failed');
                }
                return result;
            } catch (err) {
                console.error('API Error:', err.message, 'Action:', action);
                showToast('Error: ' + err.message, true);
                throw err;
            }
        }

        // Stop Staff Scanner
        function stopScanner() {
            console.log('Stop QR scanner clicked');
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                    elements.startScanner.classList.remove('hidden');
                    elements.stopScanner.classList.add('hidden');
                    elements.scannerOutput.innerText = '';
                    console.log('Scanner stopped.');
                }).catch(err => console.error('Stop scanner failed:', err));
            }
        }

        // Stop Patient Scanner
        function stopPatientScanner() {
            console.log('Stop patient QR scanner clicked');
            if (patientQrCode) {
                patientQrCode.stop().then(() => {
                    patientQrCode.clear();
                    patientQrCode = null;
                    elements.startScannerPatient.classList.remove('hidden');
                    elements.stopScannerPatient.classList.add('hidden');
                    elements.patientScannerOutput.innerText = '';
                    console.log('Patient scanner stopped.');
                }).catch(err => console.error('Stop patient scanner failed:', err));
            }
        }

        // Check Patient ID (used by both scanners)
        async function checkPatientId(patientId, isStaff = false) {
            console.log('Checking patient ID:', patientId, 'Is staff:', isStaff);
            if (!patientId.match(/^GHLK\d{4}$/)) {
                const outputElement = isStaff ? elements.scannerOutput : elements.patientScannerOutput;
                outputElement.innerText = 'Invalid QR code format.';
                return;
            }
            try {
                const result = await apiRequest('getPatients');
                const patient = result.data.find(p => p.id === patientId);
                if (isStaff) {
                    document.getElementById('noDetails').classList.add('hidden');
                    document.getElementById('patientDetailsSection').classList.add('hidden');
                    elements.editPatientSection.classList.add('hidden');
                    elements.attendanceForm.classList.remove('hidden');
                    if (patient) {
                        document.getElementById('patientDetails').innerHTML = `
                            <p><strong>ID:</strong> ${sanitize(patient.id)}</p>
                            <p><strong>Name:</strong> ${sanitize(patient.name)}</p>
                            <p><strong>Address:</strong> ${sanitize(patient.address)}</p>
                            <p><strong>Age:</strong> ${sanitize(patient.age.toString())}</p>
                            <p><strong>Phone:</strong> ${sanitize(patient.phone)}</p>
                            <p><strong>Health Issues:</strong> ${sanitize(patient.healthIssues)}</p>
                            <p><strong>Surgery History:</strong> ${sanitize(patient.surgery)}</p>
                            <p><strong>Paralysis Status:</strong> ${sanitize(patient.paralysisStatus)}</p>
                            <p><strong>Other Details:</strong> ${sanitize(patient.otherDetails)}</p>
                            <p><strong>Joining Date:</strong> ${sanitize(patient.joiningDate)}</p>
                            <p><strong>Health Status:</strong> ${sanitize(patient.healthStatus)}</p>
                        `;
                        document.getElementById('editId').value = patient.id;
                        document.getElementById('editName').value = patient.name;
                        document.getElementById('editAddress').value = patient.address;
                        document.getElementById('editAge').value = patient.age;
                        document.getElementById('editPhone').value = patient.phone;
                        document.getElementById('editHealthIssues').value = patient.healthIssues;
                        document.getElementById('editSurgery').value = patient.surgery;
                        document.getElementById('editParalysisStatus').value = patient.paralysisStatus;
                        document.getElementById('editOtherDetails').value = patient.otherDetails;
                        document.getElementById('editJoiningDate').value = patient.joiningDate.split('/').reverse().join('-');
                        const attendanceResult = await apiRequest('getAttendance');
                        const patientRecords = attendanceResult.data.filter(r => r.patientId === patientId);
                        const tbody = document.querySelector('#patientAttendanceTable tbody');
                        tbody.innerHTML = '';
                        patientRecords.forEach(r => {
                            const row = `<tr>
                                <td>${sanitize(r.date)}</td>
                                <td>${sanitize(r.bedNumber || '-')}</td>
                                <td>${sanitize(r.healthStatus)}</td>
                            </tr>`;
                            tbody.innerHTML += row;
                        });
                        document.getElementById('patientDetailsSection').classList.remove('hidden');
                        document.getElementById('patientId').value = '';
                    } else {
                        document.getElementById('noDetails').classList.remove('hidden');
                        elements.scannerOutput.innerText = 'No patient found for this ID.';
                    }
                } else {
                    document.getElementById('patientInfo').classList.add('hidden');
                    if (patient) {
                        document.getElementById('patientInfoDetails').innerHTML = `
                            <p><strong>ID:</strong> ${sanitize(patient.id)}</p>
                            <p><strong>Name:</strong> ${sanitize(patient.name)}</p>
                            <p><strong>Joining Date:</strong> ${sanitize(patient.joiningDate)}</p>
                        `;
                        document.getElementById('patientInfo').classList.remove('hidden');
                    } else {
                        elements.patientScannerOutput.innerText = 'No patient found for this ID.';
                    }
                }
            } catch (err) {
                console.error('Check patient ID error:', err);
                const outputElement = isStaff ? elements.scannerOutput : elements.patientScannerOutput;
                outputElement.innerText = 'Error fetching patient data.';
                showToast('Failed to fetch patient data: ' + err.message, true);
            }
        }

        // Staff QR Scanner
        elements.startScanner.addEventListener('click', function() {
            console.log('Start QR scanner clicked');
            if (html5QrCode) return;
            if (window.location.hostname !== 'localhost') {
                showToast('QR scanning requires localhost or HTTPS. Please run on http://localhost:5500.', true);
                return;
            }
            html5QrCode = new Html5Qrcode('qrVideo');
            const qrCodeSuccessCallback = (decodedText) => {
                console.log('QR code scanned:', decodedText);
                let patientId = decodedText.match(/^GHLK\d{4}$/) ? decodedText : decodedText.split('/').pop();
                elements.scannerOutput.innerText = `Successfully scanned: ${patientId}`;
                stopScanner();
                document.getElementById('patientId').value = patientId;
                checkPatientId(patientId, true);
            };
            const qrCodeErrorCallback = () => {
                elements.scannerOutput.innerText = '';
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: 'environment' }, config, qrCodeSuccessCallback, qrCodeErrorCallback)
                .then(() => {
                    elements.startScanner.classList.add('hidden');
                    elements.stopScanner.classList.remove('hidden');
                    elements.scannerOutput.innerText = 'Scanning...';
                })
                .catch(err => {
                    console.error('Scanner Start Failed:', err);
                    showToast('Camera access denied. Please allow camera access.', true);
                    elements.scannerOutput.innerText = '';
                    html5QrCode = null;
                });
        });

        elements.stopScanner.addEventListener('click', stopScanner);

        // Patient QR Scanner
        elements.startScannerPatient.addEventListener('click', function() {
            console.log('Start patient QR scanner clicked');
            if (patientQrCode) return;
            if (window.location.hostname !== 'localhost') {
                showToast('QR scanning requires localhost or HTTPS. Please run on http://localhost:5500.', true);
                return;
            }
            patientQrCode = new Html5Qrcode('patientQrVideo');
            const qrCodeSuccessCallback = (decodedText) => {
                console.log('Patient QR code scanned:', decodedText);
                let patientId = decodedText.match(/^GHLK\d{4}$/) ? decodedText : decodedText.split('/').pop();
                elements.patientScannerOutput.innerText = `Successfully scanned: ${patientId}`;
                stopPatientScanner();
                checkPatientId(patientId, false);
            };
            const qrCodeErrorCallback = () => {
                elements.patientScannerOutput.innerText = '';
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            patientQrCode.start({ facingMode: 'environment' }, config, qrCodeSuccessCallback, qrCodeErrorCallback)
                .then(() => {
                    elements.startScannerPatient.classList.add('hidden');
                    elements.stopScannerPatient.classList.remove('hidden');
                    elements.patientScannerOutput.innerText = 'Scanning...';
                })
                .catch(err => {
                    console.error('Patient Scanner Start Failed:', err);
                    showToast('Camera access denied. Please allow camera access.', true);
                    elements.patientScannerOutput.innerText = '';
                    patientQrCode = null;
                });
        });

        elements.stopScannerPatient.addEventListener('click', stopPatientScanner);

        // Toggle Login Section
        elements.loginButton.addEventListener('click', () => {
            console.log('Login button clicked');
            elements.loginSection.classList.remove('hidden');
            elements.patientQrSection.classList.add('hidden');
            elements.staffDashboard.classList.add('hidden');
            elements.publicSection.classList.remove('hidden');
        });

        // Toggle Patient QR Section
        elements.patientQrButton.addEventListener('click', () => {
            console.log('Patient QR button clicked');
            elements.patientQrSection.classList.remove('hidden');
            elements.loginSection.classList.add('hidden');
            elements.staffDashboard.classList.add('hidden');
            elements.publicSection.classList.remove('hidden');
            stopPatientScanner();
        });

        // Login Handling
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = sanitize(document.getElementById('username').value.trim());
            const password = document.getElementById('password').value.trim();
            console.log('Login attempt:', { username });
            const isValid = staffCredentials.some(cred => cred.username === username && cred.passwordHash === password);
            if (isValid) {
                try {
                    console.log('Toggling to staff dashboard');
                    elements.loginSection.classList.add('hidden');
                    elements.patientQrSection.classList.add('hidden');
                    elements.staffDashboard.classList.remove('hidden');
                    elements.publicSection.classList.add('hidden');
                    await Promise.all([
                        loadPatients(),
                        loadAttendance(),
                        loadReviews(),
                        loadChart()
                    ]);
                    console.log('Data loaded successfully');
                    showToast('Logged in successfully!');
                } catch (err) {
                    console.error('Login process error:', err);
                    showToast('Logged in, but failed to load data: ' + err.message, true);
                    elements.staffDashboard.classList.remove('hidden');
                    elements.publicSection.classList.add('hidden');
                }
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                console.log('Invalid credentials');
            }
        });

        // Logout Handling
        document.getElementById('logoutButton').addEventListener('click', function() {
            console.log('Logout button clicked');
            elements.staffDashboard.classList.add('hidden');
            elements.loginSection.classList.add('hidden');
            elements.patientQrSection.classList.add('hidden');
            elements.publicSection.classList.remove('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        });

        // Show Registration Form
        elements.showRegisterForm.addEventListener('click', function() {
            console.log('Show register form clicked');
            elements.registerSection.classList.remove('hidden');
            elements.idCardSection.classList.add('hidden');
            this.parentElement.classList.add('hidden');
            clearFormErrors('patientForm');
        });

        // Patient Registration
        elements.patientForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            clearFormErrors('patientForm');

            try {
                const name = sanitize(document.getElementById('name').value.trim());
                const address = sanitize(document.getElementById('address').value.trim());
                const age = parseInt(document.getElementById('age').value);
                const phone = sanitize(document.getElementById('phone').value.trim());
                const healthIssues = sanitize(document.getElementById('healthIssues').value.trim());
                const surgery = sanitize(document.getElementById('surgery').value.trim());
                const paralysisStatus = document.getElementById('paralysisStatus').value;
                const otherDetails = sanitize(document.getElementById('otherDetails').value.trim());
                const joiningDate = document.getElementById('joiningDate').value || new Date().toISOString().split('T')[0];

                let valid = true;
                if (!name.match(/^[A-Za-z\s]+$/)) {
                    showFormError('name', 'nameError');
                    valid = false;
                }
                if (!address) {
                    showFormError('address', 'addressError');
                    valid = false;
                }
                if (isNaN(age) || age < 0 || age > 120) {
                    showFormError('age', 'ageError');
                    valid = false;
                }
                if (!phone.match(/^[0-9\s\-\+\(\)]+$/)) {
                    showFormError('phone', 'phoneError');
                    valid = false;
                }
                if (!healthIssues) {
                    showFormError('healthIssues', 'healthIssuesError');
                    valid = false;
                }
                if (!paralysisStatus) {
                    showFormError('paralysisStatus', 'paralysisStatusError');
                    valid = false;
                }
                if (!joiningDate || new Date(joiningDate) > new Date()) {
                    showFormError('joiningDate', 'joiningDateError');
                    valid = false;
                }

                if (!valid) {
                    showToast('Please correct the highlighted fields.', true);
                    return;
                }

                const patient = {
                    name,
                    address,
                    age,
                    phone,
                    healthIssues,
                    surgery: surgery || 'None',
                    paralysisStatus,
                    otherDetails: otherDetails || 'None',
                    joiningDate
                };
                console.log('Submitting patient:', patient);
                const result = await apiRequest('addPatient', patient);
                patient.id = result.id;
                patient.healthStatus = 'Stable';

                await loadPatients();
                this.reset();
                showToast(`Patient ${patient.id} registered successfully!`);
                generateIdCard(patient);
                initIdCardButtons(patient);
            } catch (err) {
                console.error('Registration error:', err);
                showToast('Registration failed: ' + err.message, true);
            }
        });

        // Edit Patient Details
        elements.editDetailsButton.addEventListener('click', function() {
            console.log('Edit details button clicked');
            elements.editPatientSection.classList.remove('hidden');
            elements.attendanceForm.classList.add('hidden');
        });

        elements.cancelEdit.addEventListener('click', function() {
            console.log('Cancel edit clicked');
            elements.editPatientSection.classList.add('hidden');
            elements.attendanceForm.classList.remove('hidden');
            clearFormErrors('editPatientForm');
        });

        elements.editPatientForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            clearFormErrors('editPatientForm');

            try {
                const id = sanitize(document.getElementById('editId').value.trim());
                const name = sanitize(document.getElementById('editName').value.trim());
                const address = sanitize(document.getElementById('editAddress').value.trim());
                const age = parseInt(document.getElementById('editAge').value);
                const phone = sanitize(document.getElementById('editPhone').value.trim());
                const healthIssues = sanitize(document.getElementById('editHealthIssues').value.trim());
                const surgery = sanitize(document.getElementById('editSurgery').value.trim());
                const paralysisStatus = document.getElementById('editParalysisStatus').value;
                const otherDetails = sanitize(document.getElementById('editOtherDetails').value.trim());
                const joiningDate = document.getElementById('editJoiningDate').value;
                const healthStatus = document.getElementById('healthStatus').value;

                let valid = true;
                if (!name.match(/^[A-Za-z\s]+$/)) {
                    showFormError('editName', 'editNameError');
                    valid = false;
                }
                if (!address) {
                    showFormError('editAddress', 'editAddressError');
                    valid = false;
                }
                if (isNaN(age) || age < 0 || age > 120) {
                    showFormError('editAge', 'editAgeError');
                    valid = false;
                }
                if (!phone.match(/^[0-9\s\-\+\(\)]+$/)) {
                    showFormError('editPhone', 'editPhoneError');
                    valid = false;
                }
                if (!healthIssues) {
                    showFormError('editHealthIssues', 'editHealthIssuesError');
                    valid = false;
                }
                if (!paralysisStatus) {
                    showFormError('editParalysisStatus', 'editParalysisStatusError');
                    valid = false;
                }
                if (!joiningDate || new Date(joiningDate) > new Date()) {
                    showFormError('editJoiningDate', 'editJoiningDateError');
                    valid = false;
                }

                if (!valid) {
                    showToast('Please correct the highlighted fields.', true);
                    return;
                }

                const patient = {
                    id,
                    name,
                    address,
                    age,
                    phone,
                    healthIssues,
                    surgery: surgery || 'None',
                    paralysisStatus,
                    otherDetails: otherDetails || 'None',
                    joiningDate,
                    healthStatus
                };
                console.log('Submitting edited patient:', patient);
                await apiRequest('editPatient', patient);
                await loadPatients();
                elements.editPatientSection.classList.add('hidden');
                elements.attendanceForm.classList.remove('hidden');
                showToast(`Patient ${id} updated successfully!`);
                await checkPatientId(id, true);
            } catch (err) {
                console.error('Update error:', err);
                showToast('Update failed: ' + err.message, true);
            }
        });

        // Check Patient ID (Manual)
        document.getElementById('checkId').addEventListener('click', async function() {
            console.log('Check ID button clicked');
            const patientId = sanitize(document.getElementById('patientId').value.trim());
            clearFormErrors('patientId');
            if (!patientId.match(/^GHLK\d{4}$/)) {
                showFormError('patientId', 'patientIdError');
                showToast('Invalid Patient ID format (e.g., GHLK0001).', true);
                return;
            }
            await checkPatientId(patientId, true);
        });

        // Attendance & Bed Management
        elements.attendanceForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Attendance form submitted');
            const patientId = sanitize(document.getElementById('patientId').value.trim());
            if (!patientId.match(/^GHLK\d{4}$/)) {
                showToast('Invalid Patient ID format (e.g., GHLK0001).', true);
                return;
            }
            const bedNumber = document.getElementById('bedNumber').value || null;
            const healthStatus = document.getElementById('healthStatus').value;
            try {
                await apiRequest('addAttendance', { patientId, bedNumber, healthStatus });
                await Promise.all([loadPatients(), loadAttendance(), loadChart()]);
                await checkPatientId(patientId, true);
                this.reset();
                showToast('Attendance marked successfully!');
            } catch (err) {
                console.error('Attendance error:', err);
                showToast('Failed to mark attendance: ' + err.message, true);
            }
        });

        // Review Submission
        elements.reviewForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            clearFormErrors('reviewForm');
            const name = sanitize(document.getElementById('reviewName').value.trim());
            const text = sanitize(document.getElementById('reviewText').value.trim());
            let valid = true;
            if (!name.match(/^[A-Za-z\s\.\-]+$/)) {
                showFormError('reviewName', 'reviewNameError');
                valid = false;
            }
            if (!text) {
                showFormError('reviewText', 'reviewTextError');
                valid = false;
            }
            if (!valid) {
                showToast('Please correct the highlighted fields.', true);
                return;
            }
            try {
                console.log('Submitting review:', { name, text });
                await apiRequest('addReview', { name, text });
                await loadReviews();
                this.reset();
                showToast('Review submitted successfully!');
            } catch (err) {
                console.error('Review submission error:', err);
                showToast('Review submission failed: ' + err.message, true);
            }
        });

        // Load Patients
        async function loadPatients() {
            try {
                console.log('Loading patients');
                const result = await apiRequest('getPatients');
                const tbody = document.querySelector('#patientTable tbody');
                tbody.innerHTML = '';
                result.data.forEach(p => {
                    const row = `<tr>
                        <td>${sanitize(p.id)}</td>
                        <td>${sanitize(p.name)}</td>
                        <td>${sanitize(p.address)}</td>
                        <td>${sanitize(p.age.toString())}</td>
                        <td>${sanitize(p.phone)}</td>
                        <td>${sanitize(p.healthIssues)}</td>
                        <td>${sanitize(p.paralysisStatus)}</td>
                        <td>${sanitize(p.surgery)}</td>
                        <td>${sanitize(p.otherDetails)}</td>
                        <td>${sanitize(p.joiningDate)}</td>
                        <td>${sanitize(p.healthStatus)}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                console.log('Patients loaded');
            } catch (err) {
                console.error('Load patients error:', err);
                showToast('Failed to load patients: ' + err.message, true);
            }
        }

        // Load Attendance
        async function loadAttendance() {
            try {
                console.log('Loading attendance');
                const result = await apiRequest('getAttendance');
                const tbody = document.querySelector('#attendanceTable tbody');
                tbody.innerHTML = '';
                result.data.forEach(r => {
                    const row = `<tr>
                        <td>${sanitize(r.date)}</td>
                        <td>${sanitize(r.patientId)}</td>
                        <td>${sanitize(r.name)}</td>
                        <td>${sanitize(r.bedNumber || '-')}</td>
                        <td>${sanitize(r.healthStatus)}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                console.log('Attendance loaded');
            } catch (err) {
                console.error('Load attendance error:', err);
                showToast('Failed to load attendance: ' + err.message, true);
            }
        }

        // Load Reviews
        async function loadReviews() {
            try {
                console.log('Loading reviews');
                const result = await apiRequest('getReviews');
                const reviewList = document.getElementById('reviewList');
                reviewList.innerHTML = '';
                result.data.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-100 p-4 rounded-md';
                    div.innerHTML = `
                        <p class="font-semibold">${sanitize(r.name)}</p>
                        <p class="text-gray-600">${sanitize(r.text)}</p>
                        <p class="text-sm text-gray-500">${sanitize(r.date)}</p>
                    `;
                    reviewList.appendChild(div);
                });
                console.log('Reviews loaded');
            } catch (err) {
                console.error('Load reviews error:', err);
                showToast('Failed to load reviews: ' + err.message, true);
            }
        }

        // Load Chart
        let statusChart = null;
        async function loadChart() {
            try {
                console.log('Loading chart');
                const result = await apiRequest('getAttendance');
                const statusCounts = { Stable: 0, Improving: 0, Critical: 0 };
                result.data.forEach(r => statusCounts[r.healthStatus]++);
                const ctx = document.getElementById('statusChart').getContext('2d');
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Stable', 'Improving', 'Critical'],
                        datasets: [{
                            label: 'Patient Status',
                            data: [statusCounts.Stable, statusCounts.Improving, statusCounts.Critical],
                            backgroundColor: ['#4CAF50', '#2196F3', '#F44336']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, title: { display: true, text: 'Count' } } }
                    }
                });
                console.log('Chart loaded');
            } catch (err) {
                console.error('Load chart error:', err);
                showToast('Failed to load chart: ' + err.message, true);
            }
        }

        // Test API Button
        elements.testApi.addEventListener('click', async () => {
            try {
                console.log('Testing API...');
                const result = await apiRequest('getReviews');
                console.log('Test API result:', result);
                showToast('API test successful!');
            } catch (err) {
                console.error('Test API error:', err);
                showToast('API test failed: ' + err.message, true);
            }
        });

        // Initialize App
        async function initialize() {
            console.log('Initializing app');
            try {
                await loadReviews();
                console.log('Reviews loaded on startup');
            } catch (err) {
                console.error('Initialization error:', err);
            }
        }

        initialize();
    </script>
</body>
</html>